<polymer-element name="pl-cap-preguntas">
  <template>
	  <style>
		  :host { 
			  display: block;
			  padding: 0px;  
		  }
		
		paper-checkbox + span{
			padding: 10px 0px 0px 10px
		}
		
		paper-checkbox {
			padding: 10px 0px 0px 0px
		}
	  </style>
	  <app-header-panel on-l-icon-tap="{{ firePreguntasBack }}"	licon="arrow-back" ricon="add-circle"
						on-r-icon-tap="{{handlerShowNuevaPregunta}}"
						titulo="{{capitulo.Titulo}}" tclass="small">
		  <div layout vertical center>
			  <template repeat="{{item in preguntas}}">
				  <pl-cap-pregunta-card item="{{item}}"  guias="{{guias}}"
									on-edit-pregunta="{{handlerShowEditPregunta}}"
									on-delete-pregunta="{{handlerShowDeletePregunta}}"
									on-mostrar-guias-to-select="{{delegateShowGuiasToSelect}}"
									on-remove-guia="{{ handlerShowRemoveGuia }}"
									on-nueva-q="{{handlerShowNuevaQ}}"
									on-remove-q="{{handlerShowRemoveQ}}"
									on-edit-q="{{handlerShowEditQ}}">
				  </pl-cap-pregunta-card>
			  </template>
		  </div>
	  </app-header-panel> 	  
	  <paper-dialog id="dialog" backdrop style="top:0px;">
		  <paper-input label="Numeral" required floatinglabel id="Numeral" value="{{_onedit.Numeral}}">
		  </paper-input>
		  <paper-input label="Enunciado" required floatinglabel id="Enunciado" value="{{_onedit.Enunciado}}"
					   multiline rows="4">
		  </paper-input>
		  <div horizontal layout>
			  <paper-checkbox id="NoAplicaDisponible" checked="{{ _onedit.NoAplicaDisponible }}"></paper-checkbox>
			  <span>Disponible 'No Aplica'</span>
		  </div>
		  <paper-input label="Metodo" floatinglabel id="Metodo" value="{{_onedit.Metodo}}"
					   multiline rows="2"></paper-input>			
		  <paper-icon-button icon="cancel" dismissive></paper-icon-button>
		  <paper-icon-button icon="check" 
							 on-tap="{{ delegateSavePregunta }}"
							 affirmative autofocus>
		  </paper-icon-button>
		</paper-dialog>
	    <paper-dialog id="borrar" backdrop style="top:0px;">
		    <paper-input disabled label="Numeral" required floatinglabel value="{{_onedit.Numeral}}">
		    </paper-input>
			<paper-input disabled label="Enunciado"  floatinglabel value="{{_onedit.Enunciado}}"
						 multiline rows="4">
			</paper-input>
			<div horizontal layout>
			  <paper-checkbox disabled checked="{{ _onedit.NoAplicaDisponible }}"></paper-checkbox>
			  <span>Disponible 'No Aplica'</span>
		    </div>
			<paper-input disabled label="Metodo" floatinglabel  value="{{_onedit.Metodo}}"
						 multiline rows="2"></paper-input>
			<paper-icon-button icon="cancel" dismissive></paper-icon-button>
			<paper-icon-button icon="check" 
							   on-tap="{{ delegateDeletePregunta }}"
							   affirmative autofocus>
			</paper-icon-button>
		</paper-dialog>
	  <paper-dialog id="removeGuia" heading="Remover Guia?" backdrop style="top:0px;">
			<paper-icon-button icon="cancel" dismissive></paper-icon-button>
			<paper-icon-button icon="check" 
							   on-tap="{{ delegateRemoveGuia }}"
							   affirmative autofocus>
			</paper-icon-button>
	  </paper-dialog>
	  
	  <paper-dialog id="dialogQ" backdrop style="top:0px;">
		  <paper-input label="Enunciado" required floatinglabel value="{{_qText}}" id="EnunciadoQ"
					   multiline rows="4">
		  </paper-input>
		  <paper-icon-button icon="cancel" dismissive></paper-icon-button>
		  <paper-icon-button icon="check" 
							 on-tap="{{ delegateSaveQ }}"
							 affirmative autofocus>
		  </paper-icon-button>
		</paper-dialog>
	    <paper-dialog id="dialogRemoveQ" backdrop style="top:0px;">
		  <paper-input label="Enunciado" readOnly required floatinglabel value="{{_qText}}"
					   multiline rows="4"></paper-input>
		  <paper-icon-button icon="cancel" dismissive></paper-icon-button>
		  <paper-icon-button icon="check" 
							 on-tap="{{ delegateRemoveQ }}"
							 affirmative autofocus>
		  </paper-icon-button>
		</paper-dialog>
	  
	  
  </template>
  <script>
    Polymer({						
		 get current() {
			return this._current;
		  },
		
		created:function(){
			this.capitulo={};
			this.preguntas =[];
			this.guias=[];
			this._current={};
			this._onedit={};
		},
		
		firePreguntasBack:function(){
			this.fire("preguntas-back");
		},
		
		handlerShowNuevaQ:function(event, detail, sender){
			this._current=sender.templateInstance.model.item;
			this._onedit= Object.clone(this._current);
			this._qIndex=-1;
			this._qText="";
			this.$.dialogQ.toggle();
		},
		
		handlerShowEditQ:function(event, detail, sender){
			this._current=sender.templateInstance.model.item;
			this._onedit= Object.clone(this._current);
			this._qIndex=detail.index;
			this._qText= detail.item;
			this.$.dialogQ.toggle();
		},
		
		handlerShowRemoveQ:function(event, detail, sender){
			this._current=sender.templateInstance.model.item;
			this._onedit= Object.clone(this._current);
			this._qIndex=detail.index;
			this._qText= detail.item;
			this.$.dialogRemoveQ.toggle();
		},
		
		handlerShowEditPregunta:function(e, detail, sender){	
			this._current=sender.templateInstance.model.item;
			this._onedit= Object.clone(this._current);
			this.$.dialog.toggle();
		},
				
		handlerShowNuevaPregunta:function(){
			this._current={Enunciado:"", Metodo:"", NoAplicaDisponible:false, IdCapitulo:"", IdGuias:[]};
			this._onedit= Object.clone(this._current);
			this.$.dialog.toggle();
		},
				
		handlerShowDeletePregunta:function(e, detail, sender){	
			this._onedit=sender.templateInstance.model.item;
			this.$.borrar.toggle();
		},
		
		delegateDeletePregunta:function(e, detail, sender){
			if(this.handlerDeletePregunta){
				this.handlerDeletePregunta(e, {item:this._onedit}, sender);
			}
		},
		
		delegateSavePregunta:function(e, detail, sender){				
			if(this.$.Enunciado.invalid || this.$.Numeral.invalid ||
			   Object.compare(this._current, this._onedit)) return;
						
			if(this.handlerSavePregunta){
				this._onedit.IdCapitulo= this.capitulo.Id;
				this.handlerSavePregunta(e, {item:this._onedit}, sender);
			}			
		},
		
		delegateRemoveGuia:function(e, detail, sender){
			if(this.handlerRemoveGuia){
				var index=-1;
				for (var d in this._onedit.IdGuias){
					if( this._onedit.IdGuias[d]=== this.guiaToRemove){
						index= this._onedit.IdGuias.indexOf(this._onedit.IdGuias[d]);
						break;
					}
				}
				if(index>=0){
					this._onedit.IdGuias.splice(index,1);
					this.handlerRemoveGuia(e, {item:this._onedit, guia:this.guiaToRemove}, sender);
				}
			}
		},
					
		delegateShowGuiasToSelect:function(e, detail, sender){
			this._current=sender.templateInstance.model.item;
			this._onedit= Object.clone(this._current);
			if(this.handlerShowGuiasToSelect){
				this.handlerShowGuiasToSelect(e, {item:this._current}, sender);
			}
		},
		
		delegateSaveQ:function(e, d, s){
			if(this.handlerSaveQ){
				if(this.$.EnunciadoQ.invalid ||
				   (this._qIndex<0?false:( this._onedit.Preguntas[this._qIndex]===this.$.EnunciadoQ ) )){
					return;
				}
				if(this._qIndex<0){
					if(!this._onedit.Preguntas){
						this._onedit.Preguntas=[];
					}
					this._onedit.Preguntas.push(this.$.EnunciadoQ.value);
				}
				else{
					this._onedit.Preguntas[this._qIndex]=this.$.EnunciadoQ.value;
				}
				this.handlerSaveQ(e, {item:this._onedit}, s);
			}
		},
		
		delegateRemoveQ:function(e, d, s){
			if(this.handlerRemoveQ){
				this._onedit.Preguntas.splice(this._qIndex,1);
				this.handlerRemoveQ(e, {item:this._onedit}, s);
			}
		},
		
		handlerShowRemoveGuia:function(e,detail, sender){
			this._current= sender.templateInstance.model.item;
			this._onedit= Object.clone(this._current);
			this.guiaToRemove= detail.guia;
			this.$.removeGuia.toggle();
		}
    });
  </script>
</polymer-element>