<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../../bower_components/core-icons/core-icons.html">
<link rel="import" href="../../bower_components/core-icon/core-icon.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/core-overlay/core-overlay.html">
<link rel="import" href="cuestionario-quiz-card.html">
<link rel="import" href="cuestionario-guia-card.html">

<polymer-element name="cuestionario-panel" attributes="capitulo">

  <template>
    <style> 
		
      #header{
        width: 100vw;
        height: 100vh;
        left: 0px;
        top: 0px;
        position: absolute;
      }
      #toolbar{
        color: rgb(255, 255, 255);
        background-color: rgb(79, 125, 201);
      }
      #section{
        position: absolute;
        top: 0px;
        bottom: 0px;
        left: 0px;
        right: 0px;
        overflow: auto;
      }
		
		.container {
			width: 80vw;
			height: 55vh;
			margin: 10px auto;
		}
		.container-pie {
			width: 80vw;
			margin: 10px auto;
		}
		
		@media (min-width: 481px) {
			.container, .container-pie {
				width: 400px;
			}
			
		}
		.container-guia {
			width: 80vw;
			height: 40vh;
			min-height: 300px;
			max-width: 512px;
			margin: 10px auto;
		}
		.container-guia-pie {
			width: 80vw;
			max-width: 512px;
			margin: 10px auto;
		}
				
		/*-----------
		/*TABLE PORTRAIT */
		@media only screen and (max-width : 640px) and (orientation:portrait)
		{  .container-guia{min-height: 300px;} }
		/* TABLET LANDSCAPE STYLES */
		@media only screen and (min-width : 642px) and (orientation:landscape)
		{  .container-guia{min-height: 200px;}}
		/*-----------*/
			
		
		#capitulo{
			font-size: medium;
		}
		
		#pie, #pieGuia{
			width: 100%;
			background-color: white;
			padding: 8px 20px;
			width: 100%;
			box-shadow: 0 2px 5px 0 ;
			border-radius: 2px;
		}
		
		.navicon{
			width: 56px;
			height: 56px;
			background-color: #f5f5f5;
			fill: #000;
		}
		
    </style>

   	    
	  <core-header-panel mode="standard" id="header">
		  <core-toolbar id="toolbar" class="narrow">
			 <paper-icon-button icon="arrow-back" style="margin:0px;" 
								on-tap="{{ fireBackTap }}"></paper-icon-button>
			 <div flex id="capitulo">{{capitulo.Titulo}}</div>
		  </core-toolbar>
		  <section id="section">
			  <div id="quiz">
			  <div layout vertical center class="container">
				  <cuestionario-quiz-card pregunta="{{ quiz }}" respuesta="{{ answer }}" 
							 on-quiz-answered="{{quizAnswered}}">
				  </cuestionario-quiz-card>  
			  </div>
			  <div  layout vertical center class="container-pie">
				  <div id="pie" layout horizontal center >
					  <paper-fab icon="chevron-left" on-tap="{{ prevTap }}" 
								 class="navicon"
								 style="visibility:{{capitulo.Current>0?'visible':'hidden'}};">
					  </paper-fab>
					  <div flex layout vertical center>{{capitulo.Current+1}} de {{capitulo.Preguntas.length}}</div>
					  <paper-fab icon="check" on-tap="{{ nextTap }} " class="navicon"
										 style="visibility:{{( answer.Valor == null) && ( quiz.NoAplicaDisponible?!answer.NoAplicaChecked:true )?'hidden':'visible' }};">
					  </paper-fab>
				  </div>
			  </div>
			  </div>
			  <core-overlay id="guia" backdrop autoCloseDisabled>
				  <div style="position: fixed;left: 0px;width: 100vw;top: 0px;height: auto;background-color:transparent;">
					  <div layout vertical center class="container-guia">
						  <cuestionario-guia-card pregunta="{{guia.Guia}}" respuesta="{{guia.Respuesta}}" >
							  </cuestionario-guia-card>
					  </div>
					  					  
					  <div  layout vertical center class="container-guia-pie">
						  <div id="pieGuia" layout horizontal center >
							  <paper-fab icon="chevron-left" on-tap="{{ prevGuiaTap }}" 
										 class="navicon"
										 style="visibility:{{currentGuiaIndex>0?'visible':'hidden'}};">
							  </paper-fab>
							  <div flex layout vertical center> Guia {{currentGuiaIndex+1}} de {{guias.length}}</div>
							  <paper-fab icon="check" on-tap="{{ nextGuiaTap }} " class="navicon">
							  </paper-fab>
						  </div>
					  </div>
				
				  </div>
			  </core-overlay>
					  			  
			
		  </section>
		  
	  </core-header-panel>

	</template>

  <script>
	  Polymer({
		  index:0,
		  
		  created:function(){
			  this.quiz={};
			  this.answer={};
			  this.guia={Guia:{}, Respuesta:{}};
			  this.currentGuiaIndex=0;
			  this.guias=[];
		  },
		  
		  fireBackTap: function (event, detail, sender) {
			  this.fire('back-tap');
		  },
		  
		  nextTap:function(event, detail, sender) {
				  
			  if(!Object.compare(this.capitulo.Preguntas[this.capitulo.Current].Respuesta, this.answer)){
				  var self=this;
				  app.saveRespuesta(self.answer, function(){
					  self.capitulo.Preguntas[self.capitulo.Current].Respuesta= Object.clone(self.answer);
					  self.__next();
				  }, function(error){});					  
			  }
			  else{
				  this.__next();
			  }
			
		  },
		  
		  __next:function(){
			  
			  if( this.answer.Valor===0  && this.quiz.Guias.length>0){
				  var self= this;
				  app.getGuias(self.quiz.Guias,function(g){
					  self.guias=g;
					  self.guia= Object.clone(self.guias[self.currentGuiaIndex]);
					  self.$.guia.toggle();
				  });  
			  }
			  else{
				  this.__next__();
			  }
			  
			  
		  },
		  
		  __next__:function(){
			  if( this.capitulo.Current < (this.capitulo.Preguntas.length-1)) {
				  this.capitulo.Current= this.capitulo.Current+1;
				  this.quiz= this.capitulo.Preguntas[this.capitulo.Current].Pregunta;
				  this.answer= Object.clone(this.capitulo.Preguntas[this.capitulo.Current].Respuesta);
			  }
			  else{
				  this.capitulo.Current=0;
				  this.quiz= this.capitulo.Preguntas[this.capitulo.Current].Pregunta;
				  this.answer= Object.clone(this.capitulo.Preguntas[this.capitulo.Current].Respuesta);
			  	  this.fireBackTap();
			  }
		  },
		  
		  prevTap:function(event, detail, sender){
			  if( this.capitulo.Current >0) {
				  this.capitulo.Current= this.capitulo.Current-1;
				  this.quiz= this.capitulo.Preguntas[this.capitulo.Current].Pregunta;
				  this.answer= Object.clone(this.capitulo.Preguntas[this.capitulo.Current].Respuesta);
			  }
		  },
		  
		  nextGuiaTap:function(){
			  if(!Object.compare(this.guias[this.currentGuiaIndex].Respuesta, this.guia.Respuesta)){
				  var self=this;
				  app.saveRepuestaGuia(self.guia.Respuesta, function(){
					  self.guias[self.currentGuiaIndex].Respuesta = Object.clone(self.guia.Respuesta) ;
					  self.__nextGuiaTap();
				  }, function(){});
			  }
			  else{
				  this.__nextGuiaTap();
			  }
		  },
		  
		  
		  prevGuiaTap:function(){
			  if(this.currentGuiaIndex>0){
				  this.currentGuiaIndex-=1;
				  this.guia= Object.clone(this.guias[this.currentGuiaIndex]);
			  }
			  
		  },
		  
		  __nextGuiaTap:function(){
			  if(this.currentGuiaIndex+1== this.guias.length){
				  this.currentGuiaIndex=0;
				  this.guia= Object.clone(this.guias[this.currentGuiaIndex]);
				  this.$.guia.toggle();
				  this.__next__();
				  return;
			  }
			  this.currentGuiaIndex+=1;
			  this.guia= Object.clone(this.guias[this.currentGuiaIndex]);
			  
		  },
			  
		  capituloChanged:function(prev, current){
			  this.quiz= this.capitulo.Preguntas[this.capitulo.Current].Pregunta;
			  this.answer= Object.clone(this.capitulo.Preguntas[this.capitulo.Current].Respuesta);
		  }
    });
  </script>
</polymer-element>