<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../../bower_components/core-icons/core-icons.html">
<link rel="import" href="../../bower_components/core-icon/core-icon.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/core-overlay/core-overlay.html">
<link rel="import" href="cuestionario-quiz-card.html">
<link rel="import" href="cuestionario-guia-card.html">
<polymer-element name="q-preguntas" attributes="capitulo, selected">
  <template>
    <style> 
    </style>
	  <app-header-panel on-l-icon-tap="{{ fireBack }}"	licon="arrow-back" ricon="work"
						titulo="{{capitulo.Numeral+': ' +capitulo.Titulo +'-'+ capitulo.Estandar}}"
						tclass="text">
		  <div class="card" layout vertical  hidden?="{{selected!='0'}}">	  
			  <div class="card-header" layout horizontal center>
				  <paper-fab icon="chevron-left" on-tap="{{ prevTap }}" 
							 class="navicon"
							 style="visibility:{{capitulo.Current>0?'visible':'hidden'}};">
				  </paper-fab>
				  <div flex layout vertical center>{{capitulo.Current+1}} de {{capitulo.Preguntas.length}}</div>
				  <paper-fab icon="check" on-tap="{{ nextTap }} " class="navicon"
									 style="visibility:{{( answer.Valor == null) && ( quiz.NoAplicaDisponible?!answer.NoAplicaChecked:true )?'hidden':'visible' }};">
				  </paper-fab>
			  </div>
			  <cuestionario-quiz-card pregunta="{{ quiz }}" respuesta="{{ answer }}" 
						 on-quiz-answered="{{quizAnswered}}">
			  </cuestionario-quiz-card>  
		  </div>
		  <div class="card" layout vertical hidden?="{{selected!='1'}}">
			  <div class="card-header" layout horizontal center >
				  <paper-fab icon="chevron-left" on-tap="{{ prevGuiaTap }}" 
							 class="navicon"
							 style="visibility:{{currentGuiaIndex>0?'visible':'hidden'}};">
				  </paper-fab>
				  <div flex layout vertical center> Guia {{currentGuiaIndex+1}} de {{guias.length}}</div>
				  <paper-fab icon="check" on-tap="{{ nextGuiaTap }} " class="navicon">
				  </paper-fab>
			  </div>
			  <cuestionario-guia-card pregunta="{{guia.Guia}}" respuesta="{{guia.Respuesta}}" >
			  </cuestionario-guia-card>
		  </div>
	  </app-header-panel>	  
	</template>
 	<script>
	  Polymer({
		  index:0,
		  selected:'-1',
		  
		  created:function(){
			  this.quiz={};
			  this.answer={};
			  this.guia={Guia:{}, Respuesta:{}};
			  this.currentGuiaIndex=0;
			  this.guias=[];
		  },
		  
		  fireBackTap: function (event, detail, sender) {
			  this.fire('back-tap');
		  },
		  
		  nextTap:function(event, detail, sender) {
				  
			  if(!Object.compare(this.capitulo.Preguntas[this.capitulo.Current].Respuesta, this.answer)){
				  var self=this;
				  if(this.saveRespuesta){
					  this.saveRespuesta(self.answer, function(response){
						  if(response.status==='ok'){
							  self.capitulo.Preguntas[self.capitulo.Current].Respuesta= Object.clone(self.answer);
						  }
						  self.__next();
					  });
				  }
				  else{
					  this.__next();
				  }
			  }
			  else{
				  this.__next();
			  }
			
		  },
		  
		  __next:function(){
			  
			  if( this.answer.Valor===0  && this.quiz.IdGuias.length>0){
				  var self= this;
				  if(this.getGuias){
					  this.getGuias(self.cuestionario, self.quiz.IdGuias, function(response){
						  if(response.status==='ok'){
							  self.guias=response.data;
							  self.guia= Object.clone(self.guias[self.currentGuiaIndex]);
							  self.selected="1";
							  //self.$.guia.toggle();
						  }
					  });
				  }
				  else{
					  this.__next__();
				  }
			  }
			  else{
				  this.__next__();
			  }  
		  },
		  
		  __next__:function(){
			  if( this.capitulo.Current < (this.capitulo.Preguntas.length-1)) {
				  this.capitulo.Current= this.capitulo.Current+1;
				  this.quiz= this.capitulo.Preguntas[this.capitulo.Current].Pregunta;
				  this.answer= Object.clone(this.capitulo.Preguntas[this.capitulo.Current].Respuesta);
			  }
			  else{
				  this.capitulo.Current=0;
				  this.quiz= this.capitulo.Preguntas[this.capitulo.Current].Pregunta;
				  this.answer= Object.clone(this.capitulo.Preguntas[this.capitulo.Current].Respuesta);
			  	  this.fireBackTap();
			  }
		  },
		  
		  prevTap:function(event, detail, sender){
			  if( this.capitulo.Current >0) {
				  this.capitulo.Current= this.capitulo.Current-1;
				  this.quiz= this.capitulo.Preguntas[this.capitulo.Current].Pregunta;
				  this.answer= Object.clone(this.capitulo.Preguntas[this.capitulo.Current].Respuesta);
			  }
		  },
		  
		  nextGuiaTap:function(){
			  if(!Object.compare(this.guias[this.currentGuiaIndex].Respuesta, this.guia.Respuesta)){
				  var self=this;
				  if(this.saveRespuestaGuia){
					  this.saveRespuestaGuia(self.guia.Respuesta, function(response){
						  if(response.status==='ok'){
							  self.guias[self.currentGuiaIndex].Respuesta = Object.clone(self.guia.Respuesta);
						  }
						  self.__nextGuiaTap(); 
					  });
				  }
				  else{
					this.__nextGuiaTap();  
				  }
			  }
			  else{
				  this.__nextGuiaTap();
			  }
		  },
		  
		  
		  prevGuiaTap:function(){
			  if(this.currentGuiaIndex>0){
				  this.currentGuiaIndex-=1;
				  this.guia= Object.clone(this.guias[this.currentGuiaIndex]);
			  }
			  
		  },
		  
		  __nextGuiaTap:function(){
			  if(this.currentGuiaIndex+1== this.guias.length){
				  this.currentGuiaIndex=0;
				  this.guia= Object.clone(this.guias[this.currentGuiaIndex]);
				  this.selected="0";
				  //this.$.guia.toggle();
				  this.__next__();
				  return;
			  }
			  this.currentGuiaIndex+=1;
			  this.guia= Object.clone(this.guias[this.currentGuiaIndex]);
			  
		  },
			  
		  capituloChanged:function(prev, current){
			  if (this.capitulo){
			  this.quiz= this.capitulo.Preguntas[this.capitulo.Current].Pregunta;
			  this.answer= Object.clone(this.capitulo.Preguntas[this.capitulo.Current].Respuesta);
			  }
		  }
    });
	</script>
</polymer-element>