<!DOCTYPE html>
<html>
<head>
    <title>${Title}</title>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="description" content="Diagnostico SGSST, Decreto 1443 de 2014">
	<meta name="mobile-web-app-capable" content="yes" />
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0"/>
    <style>
		div[red]{
			background:#d23f31;
			color:#fff
		}
		div[green]{
			background:#259b24;
			color:#fff
		}
		button[fab]{
			display: inline-block;
			position: relative;
			outline: none;
			-webkit-user-select: none;
			user-select: none;
			cursor: pointer;
			z-index: 0;
			box-sizing: border-box;
			width: 56px;
			height: 56px;
			border-radius: 50%;
			font-size:medium;
			border:0px;
		}
		button[fab][red]{
			background:#d23f31;
			color:#fff
		}
		button[fab][green]{
			background:#259b24;
			color:#fff
		}
		/* tabla */
		.tb-min, .tb-header, .tb-s-header, .tb-one-col, .tb-rq
		{
			font-family: "Lucida Sans Unicode", "Lucida Grande", Sans-Serif;
			font-size: 12px;
			background: #fff;
			width: 95%;
			border-collapse: collapse;
			text-align: left;
		}
		.tb-min th
		{
			font-size: 14px;
			font-weight: normal;
			color: #039;
			padding: 10px 8px;
			border-bottom: 2px solid #6678b1;
			text-align:center;
		}
		.tb-min td
		{
			border-bottom: 1px solid #ccc;
			color: #669;
			padding: 4px 8px;
		}

		table.tb-one-col > tr td:first-child{
			width: 100%;
		}

		table.tb-index tr td:first-child, table.tb-index tr th:first-child{
			width: 80%;
		}

		table.tb-index tr td:first-child+td{
			text-align:center;
		}

		table.tb-cmp tr td:first-child+td, table.tb-cmp tr td:first-child+td+td{
			width:48%;
		}

		table.tb-s-header tr td:first-child, table.tb-s-header tr th:first-child{
			width: 20%;
		}

		table.tb-rq tr td:first-child{
			width: 60%;
		}

		div.content, div.header, div.s-header{
			padding:0px 0px 0px 10px;
			width:auto;
		}
	    .center { margin-left: auto;    margin-right: auto;    width: 95%;  }

	    .hbar {background-color: #259b24;color: #fff;text-align: center;padding: 2px;font-size: medium; border-radius:2px;}


        @import "//ajax.googleapis.com/ajax/libs/dojo/1.10.2/dojo/resources/dojo.css";

    </style>
    <script type="text/javascript">
        var PhantomJSPrinting = {
            header: { height: "1cm", contents: function(pageNum, numPages) { return pageNum + "/" + numPages; } },
            footer: { height: "1cm", 
                      contents: function(pageNum, numPages) {
                          return "<span style='float:right'>" + pageNum + " / " + numPages + "</span>" } }
        };
        window.PhantomJSPrinting=PhantomJSPrinting;
    </script>
	<script src="//ajax.googleapis.com/ajax/libs/dojo/1.10.2/dojo/dojo.js" data-dojo-config="async: true"></script>
</head>
<body> 
	<div class="s-header">
		<div class="center">
		    <table class="tb-s-header">
		    	<thead>
					<tr>
						<th>Logo de la Empresa</th>
						<th>Nombre de la Empresa</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
		    </table>
	    </div>
	</div>
	<div class="header">
		<div class="center">
	    <table class="tb-header">
	    	<thead>
				<tr>
					<th><h2 id="Empresa.Nombre">@data.Empresa.Nombre</h2></th>
				</tr>
				<tr>
					<th><span id="Empresa.Nit">@data.Empresa.Nit</span></th>
				</tr>
			</thead>
			<tbody>
			</tbody>
	    </table>
	    </div>
	</div>
	<div class="content">
	   <div class="center" style="text-align: center;">
	    <h2>Decreto 1443/2014</h2>
	    <h3>Cumplimiento Por Capítulos</h3>
		<table class="tb-min tb-index" style="text-align: left;">
			<thead>
				<tr>
					<th>Capítulo</th>
					<th>Resultado</th>
				</tr>
			</thead>
			<tbody id="Indice"></tbody>
		</table>
		</div>
	</div>

	<div class="content" style="margin-top:20px; page-break-before: always;">
		<div class="center" style="text-align: center;">
			<h2>Decreto 1443/2014</h2>
			<h3>Cumplimiento Por Capítulos</h3>
	    	<div id="spider" style="text-align: left;height: 700px; border-radius: 10px;border: 2px solid gray;	border-style: solid;background: #e7eef6"></div>
	    	<!-- <span style='float:left'><div id="legend1"></div></span> !-->
	    </div>
	</div>

	<div class="content" style="margin-top:20px; page-break-before: always;">
	   <div class="center" style="text-align: center;">
	    <h2>Cumplimiento Por Requisitos</h2>
		<table class="tb-min tb-rq">
			<thead>
				<tr>
					<th>Requisito</th>
					<th>Resultado</th>
				</tr>
			</thead>
			<tbody id="IndiceRequisitos"></tbody>
		</table>
		</div>
	</div>

	<div class="content" style="margin-top:5px; page-break-before: always;" >
		<div class="center" style="text-align: center;">
	    	<h2>Cumplimiento Por Requisitos</h2>
			<div id="Cumplimiento" style="text-align: center;"></div>
		</div>
	</div>

    <script>
    // <![CDATA[
    	var data = ${Dto};

        require(["dojo/_base/lang","dojox/charting/Chart", "dojox/charting/axis2d/Default", "dojox/charting/plot2d/Spider",
        "dojox/charting/themes/PlotKit/blue", 
        "dojo/_base/array",  "dojo/ready"],
        function(lang, Chart, Default, Spider, PlotKit,  arrayUtil, ready){
        ready(function(){  
			
			document.getElementById("Empresa.Nombre").innerHTML= data.Empresa.Nombre;
			document.getElementById("Empresa.Nit").innerHTML= data.Empresa.Nit;

			var htmlIndice="";
			var data1={};
			var data2={};
			arrayUtil.forEach(data.Capitulos, function(capitulo,i){
				
				var estado= capitulo.TotalR>=capitulo.TotalQ?"green":"red";
                htmlIndice += lang.replace("<tr><td>{capitulo.Numeral}  {capitulo.Titulo}</td><td><button fab {estado}>{capitulo.TotalR}/{capitulo.TotalQ}</button></td></tr>",
                {
                	capitulo:capitulo,
                	estado:estado
                });
				data1[capitulo.Titulo]= 100;
				data2[capitulo.Titulo]= (capitulo.TotalR/capitulo.TotalQ)*100;
            });
            document.getElementById("Indice").innerHTML= htmlIndice;
                        
			var chart = new Chart("spider");                                                                                                
			chart.setTheme(dojox.charting.themes.PlotKit.blue);
			chart.theme.plotarea.fill = null;
			chart.theme.chart.fill = null;
			chart.addPlot("default", {
				type: "Spider",
				labelOffset: -10,
				divisions: 10,
				axisColor:      "lightgray",
				fill: null,
				spiderColor:    "silver",
				seriesFillAlpha: 0.5,
				spiderOrigin:	 0.16,
				markerSize:  	 3,
				precision:		 0,
				spiderType:	 	 "polygon"
			});

			for ( var i in data1){
				chart.addAxis(i, {  min:0, max:data1[i]});
			}
			chart.addSeries("Alcanzado", {data: data2}, { fill: "green" });
			chart.addSeries("Meta", {data: data1}, { fill: "white" });
			chart.render();
			//new Legend({chart: chart, horizontal: true}, "legend1");

			var htmlIndiceRequisitos="";

			var normas= arrayUtil.filter(data.Normas, function(item){
				return item.Alias===data.Norma;
			});

			normas= normas||[{Grupos:[]}];
			var norma= normas[0];
			console.log(data.Norma, data.Normas, norma);

			arrayUtil.forEach(norma.Grupos, function(grupo,i){
				//grupo.Titulo=grupo.Titulo||'No Aplica';
				var valor= (grupo.TotalR/grupo.TotalQ)*100;
				var green = "#259b24";
				var red = (valor>=100)?"#259b24":"#d23f31";
                htmlIndiceRequisitos += 
                lang.replace("<tr><td>{grupo.Titulo}</td><td><div class='hbar' style='background-image: linear-gradient( to right, {green}, {green} {valor}%, {red} 0% ); background: -webkit-gradient(linear, left top, right top, color-stop({valor}%,{green}), color-stop({valor}%,{red}), color-stop({valor}%,{red}), color-stop({valor}%,{red}));'>{grupo.TotalR}/{grupo.TotalQ}</div></td></tr>",
                {
                	grupo:grupo,
                	valor:valor,
                	green:green,
                	red:red
                });
				
            });
            document.getElementById("IndiceRequisitos").innerHTML= htmlIndiceRequisitos;
            //

            var htmlCumplimiento="";
			arrayUtil.forEach(norma.Grupos, function(grupo,i){
				var preguntas=[];
				arrayUtil.forEach(grupo.Codigos, function(codigo){
					var pc= arrayUtil.filter(data.Preguntas, function(item){
						return grupo.Titulo? item.Pregunta[data.Norma]===codigo:item.Pregunta.Numeral===codigo ;
					});
					preguntas= preguntas.concat(pc);
				});

				var filas="";
				arrayUtil.forEach(preguntas, function(pregunta,j){
					var marca= pregunta.Respuesta.Valor===1? 'Si': 'No';
					var comentario= pregunta.Respuesta.Valor===1? (pregunta.Pregunta.ComentarioSi)||'OK': (pregunta.Pregunta.ComentarioNo)||'Mal';
					var recomendacion= pregunta.Respuesta.Valor===1? (pregunta.Pregunta.RecomendacionSi)||'Continuar': (pregunta.Pregunta.RecomendacionNo)||'Resolver y Documentar';
					filas+=
					lang.replace('<tr><td>{marca}</td><td>{comentario}</td><td>{recomendacion}</td></tr>',{
						marca:marca,
						comentario:comentario,
						recomendacion:recomendacion
					});
				});

                htmlCumplimiento += 
                lang.replace(
'<table class="tb-min tb-cmp" style="margin-top:10px; page-break-after: always;">'+
	//'<thead>'+
		'<tr><th colspan="3">{grupo.Titulo}: {grupo.TotalR}/{grupo.TotalQ}</th></tr>'+
		'<tr><th></th><th>Comentario</th><th>Recomendación</th></tr>'+
	//'</thead>'+
	'<tbody>{filas}</tbody>'+
'</table>',
                {
                	grupo:grupo,
                	filas:filas
                });
				
            });
            document.getElementById("Cumplimiento").innerHTML= htmlCumplimiento;

			var body = document.querySelector("body");
            body.setAttribute("_ready", "true");
        });
        });
    // ]]>
    </script>
</body>
</html>

